---
- hosts: localhost
  connection: local
  vars:
    openwebui_cert_email: "{{ user_cert_email | default('jhondoe@server.com') }}"
    traefik_host: "{{ dns_name | default(ansible_default_ipv4.address) }}"
  roles:
    - role: 'grycap.docker'
  tasks:

    - name: Create open-webui directory
      file:
        path: /opt/openwebui
        state: directory
        mode: '0755'

    - name: Create docker-compose file
      copy:
        content: |
          version: '3.3'
          services:
            ollama:
              image: ollama/ollama
              container_name: ollama
              restart: always
              expose:
                - "11434"
              volumes:
                - ./ollama:/root/.ollama
              networks:
                - backend
            openwebui:
              image: ghcr.io/open-webui/open-webui:main
              container_name: open-webui
              restart: always
              expose:
                - "8080"
              volumes:
                - .:/app/backend/data
              environment:
                - OLLAMA_BASE_URL=http://ollama:11434
              networks:
                - backend
                - frontend
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.openwebui.service=openwebui"
                - "traefik.http.routers.openwebui.rule=Host(`{{ traefik_host }}`)"
                - "traefik.http.routers.openwebui.entrypoints=websecure"
                - "traefik.http.routers.openwebui.tls.certresolver=myresolver"
                - "traefik.http.services.openwebui.loadbalancer.server.port=8080"
                - "traefik.docker.network=openwebui_frontend"
            traefik:
              image: "traefik:v2.10"
              container_name: "traefik"
              command:
              #- "--log.level=DEBUG"
              - "--api.insecure=true"
              - "--providers.docker=true"
              - "--providers.docker.exposedbydefault=false"
              - "--entrypoints.web.address=:80"
              - "--entrypoints.websecure.address=:443"
              - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
              - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
              - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
              - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
              - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
              #- "--certificatesresolvers.myresolver.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
              - "--certificatesresolvers.myresolver.acme.email={{ openwebui_cert_email }}"
              - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
              ports:
              - "80:80"
              - "443:443"
              - "8080:8080"
              volumes:
              - "./letsencrypt:/letsencrypt"
              - "/var/run/docker.sock:/var/run/docker.sock:ro"
              networks:
              - frontend
          networks:
              frontend:
                  driver: bridge
              backend:
                  driver: bridge
        dest: /opt/openwebui/docker-compose.yaml
        mode: '644'

    - name: Exec docker-compose up
      docker_compose:
        project_src: /opt/openwebui/
        state: present
