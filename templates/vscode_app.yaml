tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - grycap_custom_types: https://raw.githubusercontent.com/grycap/tosca/main/custom_types.yaml

description: TOSCA template for deploying VSCode in a container

metadata:
  template_version: "1.1.0"
  template_name: VSCode Container
  display_name: Deploy VSCode in a container

topology_template:

  inputs:
    cpu:
      type: float
      description: Number of virtual cpus for the container
      default: 2.0
    gpu:
      type: integer
      description: Number of GPUs for the container
      default: 0
    memory:
      type: scalar-unit.size
      description: Memory size for the container
      default: 8 GB

    pvc_size:
      type: scalar-unit.size
      description: Size of the workspace directory
      default: 10 GB

    endpoint:
      type: string
      description: DNS name to access the GeoServer instance
      default: https://vscode

    vscode_password:
      type: string
      description: Password for VSCode 
      default: 'vscode123'

  node_templates:

    vscode_app:
      type: tosca.nodes.Container.Application.Docker
      properties:
        environment:
          SHELL: /bin/bash
          HOME: /home/coder
        command:
         - code-server
         - --config
         - /home/coder/.config/code-server/config.yaml
         - /home/workspace
      requirements:
        - host: vscode_runtime
      artifacts:
        my_image:
          #file: 'codercom/code-server:latest'
          file: 'grycap/vscode:latest'
          type: tosca.artifacts.Deployment.Image.Container.Docker
        config_map:
          file: "config.yaml"
          type: tosca.artifacts.File
          deploy_path: "/home/coder/.config/code-server/config.yaml"
          properties:
            content:
              concat:
                - |-
                    bind-addr: 0.0.0.0:8080
                    disable-telemetry: true
                    auth: password
                    cert: false
                    user-data-dir: /home/coder/.local/share/code-server
                    extensions-dir: /home/coder/.local/share/code-server
                    password: 
                - get_input: vscode_password

    # The properties of the runtime to host the container
    vscode_runtime:
      type: tosca.nodes.Container.Runtime.Docker
      capabilities:
        host:
          properties:
            num_cpus: { get_input: cpu }
            num_gpus: { get_input: gpu }
            mem_size: { get_input: memory }
            publish_ports:
              - target: 8080
                endpoint: { get_input: endpoint }
            volumes:
              - "coder_vol:/home/coder"
              - "project_vol:/home/workspace"

    coder_vol:
      type: tosca.nodes.BlockStorage
      properties:
        size: { get_input: pvc_size }

    project_vol:
      type: tosca.nodes.BlockStorage
      properties:
        size: { get_input: pvc_size }

  outputs:
    vscode_app_url:
      value: { concat: [ get_attribute: [ vscode_app, endpoints, 0 ] ] }